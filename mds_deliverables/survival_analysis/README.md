# Cormack-Jolly-Seber (CJS) Survival Analysis with Bayesian Modelling

## 0. Objective

In ecological terms, a **bottleneck** refers to a specific event that results in a sharp decline in a population over a period of time [(Pacific Salmon Foundation, 2021)](https://github.com/brahmwg/Bottlenecks_MDS_Capstone). Identifying these bottleneck points throughout the various stages of a salmon’s life cycle is crucial, as it provides valuable insights into potential interventions to improve survival rates. Our model was developed to observe the survival and detection probabilities across five stages of the salmon’s outmigration-return path, as well as the cumulative survival probability from the first stage to the last.

## 1. Folder Structure
```
- data
  |- raw             
  |- preprocessed    
- scripts
  |- preprocessing.R  
  |- survival_analysis_model.R  
- plots 
  |- p_plot.png  
  |- phi_p.png  
  |- surv_p.png  
- models 
  |- CJS_model_edited.txt               
- queries
  |- queries_for_data_extraction.md  
```

Within this folder, users will find a few sub-folders as described in the table below. 
| Folder Name | Stored File Formats | Description |
| --- | --- | --- |
| Data | csv | The data directory contains CSV files used for running the scripts stored in the scripts folder. This directory is divided into two sub-folders: `raw`, which stores data extracted from the Strait of Georgia Data Center, and `processed`, which stores preprocessed data generated after executing the `scripts/preprocessing.R` script.|
| Models | txt | The models directory contains Bayesian models generated by running the Monte-Carlo Markov Chain using JAGS with the `scripts/survival_model_analysis.R` script. |
| Scripts | .R | The scripts directory contains R scripts used for both preprocessing data and conducting the survival analysis. These scripts include necessary steps to clean, transform, and analyze the data to derive insights. |
| Queries | .md | The scripts directory stores SQL queries used for the initial data extraction process. These queries are designed to be executed within the Strait of Georgia Data Center. |
| Plots | png | The plots directory contains visualizations generated by running the `scripts/survival_model_analysis.R` script. These plots include 95% credible interval visualizations for the posterior distributions of `p`, `phi`, and `survship` variables. |

## 2. Installation
### 2.1 Required Pakcages
```
library(devtools)
library(postpack)
library(coda)
library(remotes)
library(rjags)
library(telemetyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(car)
library(lme4)
library(FactoMineR)
library(factoextra)
library(corrplot)
library(gridExtra)
library(mvnormtest)
library(MVN)
library(vegan)
library(permute)
library(lattice)
library(emmeans)
library(tidyr)
library(cluster)
library(ggrepel)
library(lmerTest)
library(survival)
library(survminer)
library(MuMIn)
library(CRM)
library(TMB)
library(RMark)
library(marked)
library(mra)
library(tidyverse)
library(knitr)
library(MCMCvis)
library(purrr)
```

### 2.2 Setting Up Environments with `renv`
#### 2.2.1 Initialization

If `renv` is not yet initialized for your project, you need to initialize it first. Open RStudio or an R console, navigate to your project directory, and run:

```         
renv::init()
```

#### 2.2.2 `renv.lock`
The `renv.lock` file contains a record of all the packages that were used in your cloned project. It specifies exact versions of each package, ensuring that these versions are reproducible across different machines.

#### 2.2.3 Activation
Before installing packages, activate `renv` by copying and pasting the command below onto your R console. This is to ensure that you're working within the project-specific environment.

```         
renv::activate()
```

#### 2.2.4 Package Installation
Install all packages that are stored in `renv.lock` file by copying and pasting the command below onto your R console. This command reads through `renv.lock` and installs listed packages. By doing this, your project environment will match that of the cloned repository.

```         
renv::restore()
```

## 3. Running Scripts
The scripts must be executed in the correct order to ensure accurate outcomes.

### 3.1 Data Extraction
Your data will need to first be collected and placed under `data/raw` folder. Follow instructions on `queries/queries_for_data_extraction.md` to run the SQL queries in the Strait of Georgia Data Center.

Currently, the `raw` folder contains sample data, which includes a subset of the complete dataset.

### 3.2 Preprocessing
To preprocess your data, navigate to the `scripts/preprocessing.R` file. In this file, locate *line 7* where the working directory is set. Update this line to reflect your desired directory path. Make sure that the specified directory contains a `data/raw` sub-folder, which should include the CSV data frames obtained from the previous data extraction step. Click `Run All`.

To be more specific, the line that needs to be updated is:

```         
setwd("~/Library/Mobile\ Documents/com~apple~CloudDocs/Documents/Personal/jel000-notes/Capstone/Bottlenecks_MDS_Capstone/survival_analysis/")
```

#### 3.2.1 Outcome
Your preprocessed CSV file will be stored under `data/preprocessed` folder.

### 3.3 Survival Analysis
To run the Cormack-Jolly-Seber (CJS) survival modelling that are built using Bayesian modelling, navigate through `scripts/survival_analysis_model.R`. In this file, locate *line 39* where the working directory is set. Make sure to keep the working directory the same as before. Click `Run All`.

To be more specific, the line that needs to be updated is:

```         
setwd("~/Library/Mobile\ Documents/com~apple~CloudDocs/Documents/Personal/jel000-notes/Capstone/Bottlenecks_MDS_Capstone/survival_analysis/")
```
#### 3.3.1 Outcome
After conducting survival analysis, you will find the results summarized in the `param_summ.csv` data frame located in the `data` folder. Additionally, visual representations of the 95% credible intervals for all variables of interest can be found in the `plots` folder.