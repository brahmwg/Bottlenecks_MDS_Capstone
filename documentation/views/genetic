 WITH merged_collections_extraction AS (
         SELECT COALESCE(ci.indiv, es.indiv) AS indiv,
            ci.mixture_collection,
            ci.id_source AS id_source_collections,
            ci.repunit,
            ci.collection,
            ci.rep_pofz,
            ci.rank AS rank_collections,
            es.sample_id,
            es.lane,
            es.stockcode,
            es.catchyear,
            es.catchjuliandate,
            es.fish,
            es.vial,
            es.tray,
            es.samplename,
            es.lifestage,
            es.clipyn,
            es.comments AS comments_extraction,
            es.pid,
            es.extractiondateyyyymmdd,
            es.extractiontech,
            es.exportdateyyyymmdd,
            es.pcrtech,
            es.resultssentddmmyyyy,
            es.status,
            es.comments2,
            es.comments3,
            es.comments4,
            es.id_source AS id_source_extraction
           FROM testing.collections_ids ci
             FULL JOIN testing.extraction_sheet es ON ci.indiv = es.indiv
        ), merged_with_species AS (
         SELECT mce.indiv,
            mce.mixture_collection,
            mce.id_source_collections,
            mce.repunit,
            mce.collection,
            mce.rep_pofz,
            mce.rank_collections,
            mce.sample_id,
            mce.lane,
            mce.stockcode,
            mce.catchyear,
            mce.catchjuliandate,
            mce.fish,
            mce.vial,
            mce.tray,
            mce.samplename,
            mce.lifestage,
            mce.clipyn,
            mce.comments_extraction,
            mce.pid,
            mce.extractiondateyyyymmdd,
            mce.extractiontech,
            mce.exportdateyyyymmdd,
            mce.pcrtech,
            mce.resultssentddmmyyyy,
            mce.status,
            mce.comments2,
            mce.comments3,
            mce.comments4,
            mce.id_source_extraction,
            sp.species,
            sp.pos_sp_id_count,
            sp.pos_sp_id_prop,
            sp.neg_sp_confirmed,
            sp.notes AS notes_species
           FROM merged_collections_extraction mce
             FULL JOIN testing.species_id sp ON mce.indiv = sp.indiv
        ), merged_with_sex AS (
         SELECT mws.indiv,
            mws.mixture_collection,
            mws.id_source_collections,
            mws.repunit,
            mws.collection,
            mws.rep_pofz,
            mws.rank_collections,
            mws.sample_id,
            mws.lane,
            mws.stockcode,
            mws.catchyear,
            mws.catchjuliandate,
            mws.fish,
            mws.vial,
            mws.tray,
            mws.samplename,
            mws.lifestage,
            mws.clipyn,
            mws.comments_extraction,
            mws.pid,
            mws.extractiondateyyyymmdd,
            mws.extractiontech,
            mws.exportdateyyyymmdd,
            mws.pcrtech,
            mws.resultssentddmmyyyy,
            mws.status,
            mws.comments2,
            mws.comments3,
            mws.comments4,
            mws.id_source_extraction,
            mws.species,
            mws.pos_sp_id_count,
            mws.pos_sp_id_prop,
            mws.neg_sp_confirmed,
            mws.notes_species,
            sx.collection AS sex_collection,
            sx.sex_id AS sex_id_value,
            sx.notes AS notes_sex_id
           FROM merged_with_species mws
             FULL JOIN testing.sex_id sx ON mws.indiv = sx.indiv
        ), final_merged_table AS (
         SELECT mws.indiv,
            mws.mixture_collection,
            mws.id_source_collections,
            mws.repunit,
            mws.collection,
            mws.rep_pofz,
            mws.rank_collections,
            mws.sample_id,
            mws.lane,
            mws.stockcode,
            mws.catchyear,
            mws.catchjuliandate,
            mws.fish,
            mws.vial,
            mws.tray,
            mws.samplename,
            mws.lifestage,
            mws.clipyn,
            mws.comments_extraction,
            mws.pid,
            mws.extractiondateyyyymmdd,
            mws.extractiontech,
            mws.exportdateyyyymmdd,
            mws.pcrtech,
            mws.resultssentddmmyyyy,
            mws.status,
            mws.comments2,
            mws.comments3,
            mws.comments4,
            mws.id_source_extraction,
            mws.species,
            mws.pos_sp_id_count,
            mws.pos_sp_id_prop,
            mws.neg_sp_confirmed,
            mws.notes_species,
            mws.sex_collection,
            mws.sex_id_value,
            mws.notes_sex_id,
            ru.mixture_collection AS mixture_collection_repunits,
            ru.indiv AS indiv_repunits,
            ru.id_source AS id_source_repunits,
            ru.repunit AS repunit_repunits,
            ru.rep_pofz AS rep_pofz_repunits,
            ru.rank AS rank_repunits
           FROM merged_with_sex mws
             FULL JOIN testing.repunits_ids ru ON mws.indiv = ru.indiv
        )
 SELECT indiv,
    mixture_collection,
    id_source_collections,
    repunit,
    collection,
    rep_pofz,
    rank_collections,
    sample_id,
    lane,
    stockcode,
    catchyear,
    catchjuliandate,
    fish,
    vial,
    tray,
    samplename,
    lifestage,
    clipyn,
    comments_extraction,
    pid,
    extractiondateyyyymmdd,
    extractiontech,
    exportdateyyyymmdd,
    pcrtech,
    resultssentddmmyyyy,
    status,
    comments2,
    comments3,
    comments4,
    id_source_extraction,
    species,
    pos_sp_id_count,
    pos_sp_id_prop,
    neg_sp_confirmed,
    notes_species,
    sex_collection,
    sex_id_value,
    notes_sex_id,
    mixture_collection_repunits,
    indiv_repunits,
    id_source_repunits,
    repunit_repunits,
    rep_pofz_repunits,
    rank_repunits
   FROM final_merged_table;
