SELECT count(*) AS count,
        CASE
            WHEN source = 'microtroll'::text THEN COALESCE(stock, 'unknown'::text)
            WHEN source = ANY (ARRAY['hatch_tag'::text, 'estuary'::text, 'river'::text]) THEN COALESCE(stock, river)
            ELSE COALESCE(stock, river)
        END AS system,
    species,
    year,
    source AS period
   FROM ods.all_tagging
  GROUP BY (
        CASE
            WHEN source = 'microtroll'::text THEN COALESCE(stock, 'unknown'::text)
            WHEN source = ANY (ARRAY['hatch_tag'::text, 'estuary'::text, 'river'::text]) THEN COALESCE(stock, river)
            ELSE COALESCE(stock, river)
        END), species, year, source
  ORDER BY (count(*)) DESC;
